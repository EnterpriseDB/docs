---
title: EDB Cloud preflight checklist
---

EDB Cloud creates and manages several different types of resources in your Azure subscription. To enable EDB Cloud to perform its operations successfully, you must complete a series of preflight checks before deploying your clusters in Azure, such as: 

 * Is there enough quota for vCPU and IP addresses in your region?

 * Are there enough SKUs available in your region?

 * Are the necessary Azure resource providers registered to your subscription?

### Azure preflight script

EDB provides an [azure-preflight](https://github.com/EnterpriseDB/cloud-utilities/blob/main/azure/azure-preflight.sh) shell script to perform the preflight checks in your subscription automatically. 

!!! Note
    Ensure that the following utilities are installed on the server where the scripts is run:
    * jq
    * azure cli v2.26 or above

1. Run 

```
git clone https://github.com/EnterpriseDB/cloud-utilities/ to get the script.
```

1. Run 

```
./cloud-utilities/azure/azure-preflight.sh --location <location> --pgtype <pg-type> --endpoint <endpoint> [--ha] [--with-infra]
```

Let us consider an example where you want deploy a cluster with the following parameters:
Region: eastus2 
Cluster type: E2s_v3
Endpoint type: public 
Existing cluster: No 

Run the following command:
./azure-preflight.sh --location eastus2 --pgtype e2s_v3 --endpoint public --with-infra

## Quota for vCPU and IP addresses

EDB Cloud infrastructure consists of VMs, vCPU cores, and Public IP addresses. 

Any time a new VM is deployed the vCPUs for the VM must not exceed the vCPU quota for the VM size family or the total regional vCPU quota. If either of those quotas are exceeded, the VM deployment will not be allowed. There is also a quota for the overall number of IP Addresses in the region. Thus, the creation of a PG cluster in one region might fail due to insufficient resources for the creation of EDB Cloud infrastructure in the designated region.

### Raising Azure resource limits

To prevent EDB Cloud from hitting resource limits, you need to

* Plan the usage
* Monitor the usage
* Increase the resource limit

The default number of total cores per subscription per region is 20. See [Virtual Machines limits - Azure Resource Manager](https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/azure-subscription-service-limits#virtual-machines-limits---azure-resource-manager) for more information. You need to increase the total cores to account for the total number of cores you expect to use in each region and reserve these cores to be used by EDB.
The next section [Planing Virtual Machine Quota](#planing-virtual-machine-quota) describes how to calculate Virtual Machine resource quota. EDB recommends the following as a best practice when requesting Virtual Machine resource quota increases:
* Total Regional vCPUs: minimum of 100+ per designated region
* Standard ESv3 Family vCPUs: minimum of 50 + per designated region
* Standard DSv2 Family vCPUs: minimum of 20+ per designated region


The default Public IP address limits for Public IP Addresses Basic and Public IP Addresses Standards is set to 10. See [Public IP address limits](https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/azure-subscription-service-limits#publicip-address) for more information.
You need to increase the limit of `Public IP Addresses - Basic` and `Public IP Addresses - Standard` for the regions where you plan to deploy your EDB clusters with the total number of EDB clusters you plan to use.
EDB recommends the following as a best practice when requesting Public IP address quota increases:

* Public IP Addresses – Basic: number of clusters you plan to deploy in a given region
* Public IP Addresses – Standard: number of clusters you plan to deploy in a given region


## Virtual machine quota requirements
In each region, BigAnimal uses eight Dv4 virtual machine cores to manage your BigAnimal infrastructure. Your Postgres clusters deployed in the region use separate ESv3 virtual machine cores. The number of cores depends on the Instance Type and High Availability options of the clusters you provision. You can calculate the number of ESv3 cores required for your cluster based on the following:

* Virtual machine instance of type E{N}Sv3 uses {N} cores. For example, an instance of type E64Sv3 uses 64 ESv3 cores.
* Cluster running on an E{N}Sv3 instance with high availability not enabled uses exactly {N} ESv3 cores.
* Cluster running on an E{N}Sv3 instance with high availability enabled uses 3 * {N} ESv3 cores.

As an example, if you provision the largest virtual machine E64Sv3 with high availability enabled, it requires (3 * 64)=192 ESv3 cores per region. BigAnimal infrastructure requires an additional eight Dv4 virtual machine cores per region.

### Checking current utilization

To check if you have adequate Azure resources to provision new clusters:

1. In the [Azure portal](https://portal.azure.com/), select **Subscription**.
2. Select your specific subscription.
3. Select **Usage + quotas** in the **Settings** section.
4. Search for "Total Regional vCPUs" and select the **Location** to check the regional vCPUs limits.
5. Search for "DSv2" and "ESv3" to view virtual machines limits.
6. Search for Public IP to view networks limits.


### Increasing network quota

You can increase the number of public IP addresses for your account either by using Azure's portal if you have appropriate privileges or by submitting a support request. See:

- [Request Networking quota increase at subscription level using Help + support](https://docs.microsoft.com/en-us/azure/azure-portal/supportability/networking-quota-requests#request-networking-quota-increase-at-subscription-level-using-help--support)

- [Request networking quota increase at subscription level using Usages + quotas](https://docs.microsoft.com/en-us/azure/azure-portal/supportability/networking-quota-requests#request-networking-quota-increase-at-subscription-level-using-usages--quotas)


### Increasing virtual machine quota

You can increase the number of ESv3 Series virtual machines per region for your account either by using Azure's portal if you have appropriate privileges or by submitting a support request. See:

- [Request a quota increase by region from Help + support](https://docs.microsoft.com/en-us/azure/azure-portal/supportability/regional-quota-requests#request-a-quota-increase-by-region-from-help--support)

- [Request a quota increase by region from subscriptions](https://docs.microsoft.com/en-us/azure/azure-portal/supportability/regional-quota-requests#request-a-quota-increase-by-region-from-subscriptions)

## Virtual Machine SKU

When you deploy your Postgres clusters in HA mode, EDB Cloud uses multiple  availability zones  of the region where th Postgres cluster deployment.
EDB Cloud uses Standard DSv2 Family vCPUs to manage workloads and Standard ESv3 Family vCPUs to manage Postgres clusters.

Ensure that all regions and zones designated for the deployment of your Postgres clusters have no  SKU restrictions for the vCPU families used by EDB Cloud: `Standard_DS2_v2` and `Standard_E2s_v3` in zone 1,2,3 of every  region designated for Postgres deployment should have no restrictions.

### Checking SKU restrictions

You can check SKU restrictions using Azure CLI. Below is the example of command to check the Standard_DS2_v2 VM SKU restriction in westus2 location for all zones:

```
az vm list-skus -l eastus2 --zone --size Standard_DS2_v2
ResourceType     Locations    Name             Zones    Restrictions
---------------  -----------  ---------------  -------  -----------------------------------------------------------------------
virtualMachines  eastus2      Standard_DS2_v2  1,2,3    NotAvailableForSubscription, type: Zone, locations: eastus2, zones: 3,2
```
The presence of entries in Restriction column would block EDB Cloud from deploying Postgres cluster in the specified region. The value in in Restrictions column must be `None` as in the example below:

```
$ az vm list-skus -l westus2 --zone --size Standard_DS2_v2
ResourceType     Locations    Name             Zones    Restrictions
---------------  -----------  ---------------  -------  --------------
virtualMachines  westus2      Standard_DS2_v2  1,2,3    None
```
To check SKU restrictions using Azure portal use [this reference documents](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/error-sku-not-available#solution-3---azure-portal).

### Fixing issues with SKU restrictions

[Open a support request](https://docs.microsoft.com/en-us/troubleshoot/azure/general/region-access-request-process)  to remove SKU restrictions in the designated region.


## Azure Service Providers
EDB Cloud creates and manages [certain types of Azure resources](https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-providers-and-types). P
Please, ensure that the following Azure service providers have been registered in your Azure subscription:

| Provider Namespace             | Purpose                                                                                                         |
| ------------------------------ | --------------------------------------------------------------------------------------------------------------- |
| Microsoft.Compute              | PG cluster workload needs to run on VirtualMachine (managed by AKS)                                             |
| Microsoft.ContainerService     | The management to PG cluster workload runs on Azure Kubernetes Service cluster                                  |
| Microsoft.KeyVault             | The PG cluster’s data volume is encrypted by keys stored in the Azure KeyVault.  The credential information created to manage all the Azure resources used by EDB Cloud in the user’s Azure subscription will also be stored in Azure KeyVault  |
| Microsoft.Storage              | The PG cluster backups the data to Azure Service Account, the data is encrypted by the key stored in AKV above. |
| Microsoft.ManagedIdentity      | The management software access to the local Azure service by Azure Managed-Identity in password-less manner     |
| Microsoft.Network              | All the management and PG cluster workload runs in AKS setup in the dedicated VNet                              |
| Microsoft.OperationalInsights  | All the management and PG clusters’ workload’s logging (log workspace)                                          |
| Microsoft.OperationsManagement | All workloads’ monitoring (container insight)                                                                   |
| Microsoft.Portal               | Predefined dashboard for user to monitor the running status of the PG clusters (aggregated logs and metrics)    |

!!! Note
    Absence of registration for any of these service providers in you Azure subscription leads to failure to create Postgres cluster in EDB Cloud.

### Managing Service Providers using Azure CLI

You can check the status of a service provides as follows:

```az provider show -n Provider.Name ```

Example:
```
$ az provider show -n Microsoft.ContainerService
Namespace                   RegistrationPolicy    RegistrationState
--------------------------  --------------------  -------------------
Microsoft.ContainerService  RegistrationRequired  NotRegistered

```
If a required provider `RegistrationStatus` is `NotRegistered`, you can register it using the [register command](https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_register)  :

```az provider register -n Provider.Name ```

Example:
```
 az provider register -n Microsoft.ContainerService
Registering is still on-going. You can monitor using 'az provider show -n Microsoft.ContainerService

```

### Managing Service Providers using Azure portal

1. In the [Azure portal](https://portal.azure.com/), select **Subscription**.
2. Select your specific subscription.
3. In navigation panel **Settings** group, select **Resource providers**.
4. Review the status of the required providers. To register a provider, select the provider, and, on the top menu, click **Register**.





See Also:

* [This blogpost](https://support.edbcloud.com/hc/en-us/articles/4408171743897-How-to-check-Azure-available-resources-and-quota-limit-with-script-azure-preflight-sh) describes the examples of the usage.

* While the script [azure-preflight.sh](https://github.com/EnterpriseDB/cloud-utilities/blob/main/azure/azure-preflight.sh) is a recommended way of performing EDB Cloud preflight check, you can also perform this check using [Azure CLI](https://docs.microsoft.com/en-us/cli/azure/) or [Azure portal](https://portal.azure.com/) as described below.