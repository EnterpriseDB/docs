---
title: "Configuring Secure Connection with PEM Server"
navTitle: "Certificates Copy"
legacyRedirectsGenerated:
  # This list is generated by a script. If you need add entries, use the `legacyRedirects` key.
  - "/edb-docs/d/edb-postgres-enterprise-manager/user-guides/administrators-guide/8.0/managing_certificates.html"
# This file is moved from pem_admin/04_managing_certificates
redirects:
- /pem/latest/pem_admin/04_managing_certificates/
---
PEM, by default, supports secured SSL or TLS connectivity and acts as its own certificate authority (CA) to generate certificates and keys for the PEM server and agent. 

During the initial PEM installation, the installer generates its own SSL CA certificates and keys for the PEM server and agent, which are then used for an encrypted connection between them. You can also replace the PEM self-signed CA certificate and key with trusted third-party CA certificates when configuring SSL on the PEM server. 

## PEM self-signed CA certificate framework

During the PEM Server configuration, the script generates self-signed CA certificates and key files for the PEM backend database server. Then, it configures the backend database server to use these certificates and keys for authentication and encryption purposes for the agent connections.

The PEM server generates the following six files in the database directory:

- `ca_certificate.crt`
- `ca_key.key`
- `root.crt`
- `root.crl`
- `server.crt`
- `server.key`

Note that the ca_certificate.crt and ca_key.key (self-signed CA certificates and key) files are used during the agent registration process to generate SSL certificates and key files for the agent. The root.crt file is a copy of the ca_certificate.crt file and used as the ROOT certificate for the backend database server, for example, set as 'ssl_ca_file' in the postgresql.conf.

Before you begin to configure PEM Self-signed CA certificates and keys, see PostgreSQL’s  [Secure TCP/IP Connections with SSL](https://www.postgresql.org/docs/current/ssl-tcp.html) for additional information about how to configure SSL on the server side. 

### PEM self-signed CA certificate expiration

The expiration date of the `ca_certificate.crt` file is monitored by the PEM agent installed with the PEM server. When the certificate is about to expire, PEM performs the following steps:

- Make a backup of the existing certificate files
- Create new certificate files, appending the new CA certificate file to the `root.crt` file on the PEM server
- Create a job that renews the certificate file of any active agents
- Restarts the PEM server

If you uninstall an agent, the certificate associated with that agent is added to the certificate revocation list maintained in the `root.crl` file to ensure you can't use the certificate to connect to the PEM server.

## Replacing PEM self-signed certificates and keys with trusted CA-signed certificates and keys

The Replacing SSL certificates topic only provides information about generating a new PEM self-signed CA certificate and key and then generating new self-signed agent certificates from that. Need more information about which PEM self-signed certificates can be replaced and how to replace them with trusted CA-signed certificates and keys.

## Installing trusted CA root and intermediate certificates

Required information about the steps and the location to install trusted CA root and intermediate certificates

## Installing trusted CA CRL

Required information about the steps and the location to install trusted CA CRL

## Disabling CRL usage by the server if trusted CA does not provide CRL

Required information about this topic. 

Comment the 'ssl_crl_file' parameter from the postgresql.conf

## Generating agent and server certificates and key

For each agent that interacts with the PEM server, you must:

-   Generate an rsa key and a certificate.
-   Copy the key and certificate to the agent.

Each agent has a unique identifier that's stored in the `pem.agent` table in the `pem` database. You must replace the key and certificate files with the key or certificate that corresponds to the agent's identifier. You must move the `agent.key` and `agent.crt` files generated in Steps 2 and 3 into place on their respective PEM agent host before generating the next key file pair. Subsequent commands overwrite the previously generated file.

To generate a PEM agent key file pair:

1.  Use psql to find the number of agents and their corresponding identifiers:

    ```shell
    /usr/pgsql-x/bin/psql -U postgres -d pem --no-psqlrc -t -A -c "SELECT ID FROM pem.agent"
    ```

-   On Linux, you can also find the agent identifier and location of the keys and certificates in the `PEMagent` section of the `/etc/postgres-reg.ini` file.

-   On Windows, the information is stored in the registry:

    -   On a 64-bit Windows installation, check:

    ```shell
    HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\EnterpriseDB\PEM\agent
    ```

    -   On a 32-bit Windows installation, check:

    ```shell
    HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\PEM\agent
    ```

2.  After identifying the agents that need key files, generate an `agent.key` for each agent. To generate the key, execute the following command, capturing the output in a file:

    ```shell
    /usr/pgsql-x/bin/psql -U postgres -d pem --no-psqlrc -t -A -c "SELECT openssl_rsa_generate_key(1024)" > agent.key
    ```

    Modify the privileges of the `agent.key` file:

    ```shell
    chmod 600 agent.key
    ```

3.  Generate a certificate for each agent. To generate a certificate, execute the following command, capturing the output in a certificate file:

    ```shell
    /usr/pgsql-x/bin/psql -U postgres -d pem --no-psqlrc -t -A -c
    "SELECT openssl_csr_to_crt(openssl_rsa_key_to_csr('$(cat agent.key)',
    'agent<$ID>', 'US', 'MA', 'Bedford', 'Postgres Enterprise Manager',
    'support@enterprisedb.com'),
    '/var/lib/pgsql/x/data/ca_certificate.crt',
    '/var/lib/pgsql/x/data/ca_key.key')" > agent.crt
    ```

    Where `$ID` is the agent number of the agent (retrieved by the psql command line).

4.  Modify the privileges of the `agent.crt` file:

    ```shell
    chmod 600 agent.crt
    ```

## Replacing server certificates and keys with existing keys and certificates

Replace each agent's key and certificate file with the newly generated files before restarting the PEM agent service:

On Linux with `init.d`, restart the service with the command:

    ```shell
    /etc/init.d/pemagent start
    ```

On Linux with `systemd`, restart the service with the command:

    ```shell
    systemctl start pemagent
    ```

On a Windows host, you can use the Services applet to start the PEM agent. The PEM agent service is named Postgres Enterprise Manager Agent. Select the service name in the Services dialog box and select **Start the service**.

Require more information.

## Configuring different agents to use a shared DB role

Require information about configuring different agents to use a shared db role. This should also cover SSL keys and certificates.

Require additional information about PEM's ca_key.key and ca_certificate.crt files if they do not have signing keys and certificates from their trusted CA and how this affects agent key and cert generation and replacement.

--Existing content

## Replacing SSL certificates

You can replace the SSL certificates on an existing PEM installation. If you plan to upgrade your server to a new version at the same time, invoke all of the PEM installers (first the server installer, then agent installers) before replacing the SSL certificates. Then:

1.  Stop all running PEM agents, first on the server host, and then on any monitored node.

    To stop a PEM agent on a Linux host, open a terminal window, assume superuser privileges, and enter the command:

    On Linux with systemd, for example, Centos 7 or 8

    ```shell
    systemctl stop pemagent
    ```

    On a Windows host, you can use the Services applet to stop the PEM agent. The PEM agent service is named Postgres Enterprise Manager Agent. Select the service name in the Services dialog box and select **Stop the service**.

2.  Take a backup of the existing SSL keys and certificates. The SSL keys and certificates are stored in the `data` directory under your PEM installation. For example, the default location on a Linux system is:

    `/var/lib/pgsql/x/data`, where `x` is the PostgreSQL database version

    Copy the following files, adding an extension to each file to make the name unique:

    -   `ca_certificate.crt`
    -   `ca_key.key`
    -   `root.crt`
    -   `root.crl`
    -   `server.key`
    -   `server.crt`

    For example, to creates a backup of the `ca_certificate` file with the word `old` appended to the entry, use this command:

    ```shell
    # cp ca_certificate.crt ca_certificate_old.crt
    ```    

3.  Use the `openssl_rsa_generate_key()` function to generate the `ca_key.key` file:

    ```shell
    /usr/pgsql-x.x/bin/psql -U postgres -d pem --no-psqlrc -t -A -c "SELECT public.openssl_rsa_generate_key(1024)" > /var/lib/pgsql/x/data/ca_key.key
    ```

    After creating the `ca_key.key` file, `cat` the contents to the variable `CA_KEY` for use when generating the `ca_certificate.crt` file. Modify the privileges on the `ca_key.key` file:

    ```shell
    CA_KEY=$(cat /var/lib/pgsql/x/data/ca_key.key)

    chmod 600 /var/lib/pgsql/x/data/ca_key.key
    ```

4.  Use the key to generate the `ca_certificate.crt` file. For simplicity, place the SQL query in a temporary file with a unique name:

    ```shell
    echo "SELECT openssl_csr_to_crt(openssl_rsa_key_to_csr('${CA_KEY}',
    'PEM','US', 'MA', 'Bedford', 'Postgres Enterprise Manager',
    'support@enterprisedb.com'), NULL,
    '/var/lib/pgsql/x/data/ca_key.key')" > /tmp/_random.$$
    ```

    Then use the variable to execute the query, placing the content in the `ca_certificate.crt` file.

    ```shell
    /usr/pgsql-x/bin/psql -U postgres -d pem --no-psqlrc -t -A -f /tmp/_random.$$ > /var/lib/pgsql/x/data/ca_certificate.crt
    ```

    Modify the permissions of the `ca_certificate.crt` file, and remove the temporary file that contained the SQL command:

    ```shell
    chmod 600 /var/lib/pgsql/x/data/ca_certificate.crt

    rm -f /tmp/_random.$$
    ```

5.  Reuse the `ca_certificate.crt` file as the `root.crt` file:

    ```shell
    cp /var/lib/pgsql/x/data/ca_certificate.crt /var/lib/pgsql/x/data/root.crt
    ```

    Modify the permissions of the `root.crt` file:

    ```shell
    chmod 600 /var/lib/pgsql/x/data/root.crt
    ```

6.  Use the `openssl_rsa_generate_crl()` function to create the certificate revocation list (`root.crl`):

    ```shell
    /usr/pgsql-x/bin/psql -U postgres -d pem --no-psqlrc -t -A -c
     "SELECT openssl_rsa_generate_crl('/var/lib/pgsql/x/data/ca_certificate.crt', '/var/lib/pgsql/x/data/ca_key.key')" > /var/lib/pgsql/x/data/root.crl
    ```

    Modify the permissions of the `root.crl` file:

    ```shell
    chmod 600 /var/lib/pgsql/x/data/root.crl
    ```

7.  Use the `openssl_rsa_generate_key()` function to generate the `server.key` file:

    ```shell
    /usr/pgsql-x/bin/psql -U postgres -d pem --no-psqlrc -t -A -c "SELECT public.openssl_rsa_generate_key(1024)" >> /var/lib/pgsql/x/data/server.key
    ```

    After creating the `server.key` file, `cat` the contents to the variable `SSL_KEY` for use when generating the `server.crt` file and modify the privileges on the `server.key` file:

    ```shell
    SSL_KEY=$(cat /var/lib/pgsql/x/data/server.key)

    chmod 600 /var/lib/pgsql/x/data/server.key
    ```

8.  Use the `SSL_KEY` to generate the server certificate. Save the certificate in the `server.crt` file. For simplicity, first place the SQL query into a temporary file with a unique name:

    ```shell
    echo "SELECT openssl_csr_to_crt(openssl_rsa_key_to_csr('${SSL_KEY}',
    'PEM','US', 'MA', 'Bedford', 'Postgres Enterprise Manager',
    'support@enterprisedb.com'),
    '/var/lib/pgsql/x/data/ca_certificate.crt',
    '/var/lib/pgsql/x/data/ca_key.key')" > /tmp/_random.$$

     /usr/pgsql-x/bin/psql -U postgres -d pem --no-psqlrc -t -A -f /tmp/_random.$$ >> /var/lib/pgsql/x/data/server.crt
    ```

9.  Modify the privileges on the `server.crt` file, and delete the temporary file:

    ```shell
    chmod 600 /var/lib/pgsql/x/data/server.crt

    rm -f /tmp/_random.$$
    ```

10. Restart the Postgres server:

       On Linux with `init.d`, for example, on a Centos6 host:

    ```shell
    /etc/init.d/postgresql-x restart
    ```

    On Linux with `systemd`, for example, on a Centos7 host:

    ```shell
    systemctl restart postgresql-x
    ```

## Updating agent SSL certificates

--Used this content above
