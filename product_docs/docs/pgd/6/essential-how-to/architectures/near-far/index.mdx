---
title: Near-Far Architecture
navTitle: Near-Far
navigation:
- manual-deployments
---

In the near/far architecture, there are two data nodes in the primary location and one data node in a secondary location. The primary location is where the majority of the data is stored and where most of the client connections are made. The secondary location is used for disaster recovery and is not used for client connections by default.

The data nodes are all configured in a multi-master replication configuration, just like the standard architecture, but the difference is that the node at the secondary location is fenced off from the other nodes in the cluster and does not receive client connections by default. In this configuration, the secondary location node has a complete replica of the data in the primary location.

Using a PGD commit scope, the data nodes in the primary location will be configured to synchronously replicate data to the other node in the primary location and to the node in the secondary location. This ensures that the data is replicated to all nodes before it is committed to on the primary location. In the case of a node going down, the commit scope rule will detect the situation and degrade the replication to asynchronous replication. This will allow the system to continue to operate. 

In the event of a partial failure at the primary location, the system will switch to the other data node, also with a complete replica of the data, and continue to operate. It will also continue replication to the secondary location. When the failed node at the primary location comes back, it will rejoin and begin replicating data from the node that is currently primary.

In the event of a complete failure in the primary location, the secondary location's database has a complete replica of the data. Depending on the failure, options for recovery include restoring the primary location from the secondary location,  or restoring the primary location from a backup of the secondary location. The secondary location could be configured to accept client connections, but this is not the default configuration and would require some additional reconfiguration.

## Synchronous Replication in Near-Far Architecture

For best results the near-far architecture should be configured with synchronous replication.
This ensures that the data is replicated to the secondary location before it is committed to the primary location.

## PGD Configuration

The primary location is configured with two data nodes, in their own group "active". This location will be where the majority of the client connections will be made.

The secondary location is configured with one data node, in its own group "dr".

They are all members of the same cluster.

Once created with pgd-cli, the routing and fencing of the nodes needs to be configured.

First, we disable the routing on both the "active" and "dr" groups.

```shell
pgd group dr set-option enable_routing off --dsn "host=localhost port=5432 dbname=pgddb user=pgdadmin"
pgd group active set-option enable_routing off --dsn "host=localhost port=5432 dbname=pgddb user=pgdadmin"
```

Then we should enable the routing on the "pgd" top-level group.

```shell
pgd group pgd set-option enable_routing on --dsn "host=localhost port=5432 dbname=pgddb user=pgdadmin"
```

Finally, we would enable the fencing on the "dr" group.

```shell
pgd group dr set-option enable_fencing on --dsn "host=localhost port=5432 dbname=pgddb user=pgdadmin"
```

This will ensure that the "dr" group is fenced off from the other nodes in the cluster and does not receive client connections by default.
The "active" group will continue to operate normally and will continue to replicate data to the "dr" group.

