---
title: Performing a Postgres major version rolling upgrade on a PGD cluster built with TPA
navTitle: Upgrade Postgres major version
deepToC: true
---

## Overview

Upgrading a Postgres database's major version to access improved features, performance enhancements, and security updates is a common administration task. Doing the same for a Postgres Distributed (PGD) cluster deployed with Trusted Postgres Architect (TPA) is essentially the same process but performed as a rolling upgrade./

The rolling upgrade process allows updating individual cluster nodes to a new major Postgres version while maintaining cluster availability and operational continuity. This approach minimizes downtime and ensures data integrity by allowing the rest of the cluster to remain operational as each node is upgraded sequentially. 

We recommend upgrading your Postgres cluster to a newer major version to access improved features, performance enhancements, and security updates. These step-by-step instructions and a worked example help to provide a smooth and controlled upgrade process.

### Plan the upgrade

A rolling upgrade means that the cluster must be available throughout the upgrade process. To achieve continuous cluster availability, you must [perform a planned switchover](#performing-a-planned-switchover) of the [write leader](../terminology/#write-leader) node before upgrading it so that a write leader is always available. 

You can see which node is the write leader by connecting to the PGD cluster (for example, using SSH) and running the `pgd show-groups` command:

```bash
sudo -u postgres pgd show-groups
```

To keep the number of planned [switchovers](https://www.enterprisedb.com/docs/pgd/latest/cli/command_ref/pgd_switchover/) to a minimum, upgrade the current write leader last in your upgrade order, so you have to perform only [one planned switchover](#performing-a-planned-switchover) during the upgrade process.

### Perform the upgrade on each node

!!! Note
To help prevent data loss, ensure that your databases and configuration files are backed up before starting the upgrade process.
!!!

Next, perform the following steps on each node in order:

1. If the target node is the current write leader, perform a [planned switchover](#plan-the-upgrade).
  - `sudo -u postgres pgd switchover --group-name <group_name> --node-name <new_write_leader_node_name>`
1. Confirm the current major Postgres version.
  - View versions from PGD by logging in and running: `SELECT * FROM bdr.group_versions_details;`. Ensure the node you're about to upgrade has the expected major version running.
1. Stop Postgres.
  - `systemctl stop postgres`
1. Install the new Postgres version and `bdr_pg_upgrade`.
  - `sudo apt install edb-bdr<pgd_version_number>-pg<postgres_version_number> edb-bdr-utilities`
1. Initialize the new Postgres version.
  - Make a new directory `/opt/postgres/datanew` to hold the upgraded PGDATA directory
  - Initialize the new version of Postgres in the new directory using the newly installed version's `initdb` 
1. Copy the configuration for the old Postgres version to the configuration for the new Postgres version.
  - Copy the current version's configuration files to the new data directory: `postgresql.conf`, `postgresql.auto.conf`, `pg_hba.conf`, and the whole `conf.d` directory.
1. Rename the PGDATA directories to switch the old versions out and the new versions in.
  - Move `/opt/postgres/data` to `/opt/postgres/dataold` and move `/opt/postgres/datanew` to `/opt/postgres/data`.
1. Double-check that both Postgres instances aren't running.
  - Use `pg_ctl` to stop both `/opt/postgres/dataold` and `/opt/postgres/data`.
1. Check that you can upgrade safely.
  - Use the `--check` option when running `bdr_pg_upgrade`.
1. Run the Postgres major version upgrade.
  - Run `bdr_pg_upgrade` again without the `--check` option.
1. Update the Postgres service configuration to the new version and refresh the system's service manager to apply the changes.
  - Replace the old version number with the new version number in the `postgres.service` file.
    - `sudo sed -i -e 's/<old_version_number>/<new_version_number>/g' /etc/systemd/system/postgres.service`
1. Start Postgres.
  - `systemctl start postgres`
1. Validate the new Postgres version. 
  - Connect to the `bdrdb` database and run `SELECT * FROM bdr.group_versions_details;`.
1. Test the upgrade directly against the newly upgraded node.
  - Run your test suite again while still connected by way of SSH into the newly upgraded node.
1. Clean up post-upgrade. 
  - Run the new PG version's `vacuumdb`.
  - Remove the old version's data directory, `/opt/postgres/dataold`.

### Reconcile the upgrade with TPA

TPA needs to continue to manage the deployment effectively after the upgrade. Therefore, it's necessary to reconcile the upgraded nodes with TPA. Follow these steps to update the configuration and redeploy the PGD cluster through TPA.

- Change the `config.yml` of the TPA-managed cluster to the new version.
  - `cluster_vars: postgres_version: '<new_version_number>'`
- Use `tpaexec` to redeploy the PGD cluster with the updated `config.yml`.
  - `tpaexec deploy <cluster_name>`

Details of these steps are shown in the worked example, specifically for upgrading a [shadow node](https://www.enterprisedb.com/docs/pgd/latest/terminology/#write-leader) from Postgres 15 to Postgres 16. 

## Worked example

This worked example starts with a [TPA-managed PGD cluster deployed using the [AWS Quickstart](https://www.enterprisedb.com/docs/pgd/latest/quickstart/quick_start_aws/). The cluster has three nodes: kaboom, kaolin, and kaftan, all running Postges 15.

In this scenario, the current write leader is kaftan. This example upgrades the first of two shadow nodes, kaboom.

!!! Note
Some steps of this process involve running commands as the Postgres owner. We refer to this user as postgres throughout, when appropriate. If you're running EDB Postgres Advanced Server, substitute the postgres user with enterprisedb in all relevant commands.
!!!

### Confirm the current Postgres version

SSH into kaboom and use the following command to connect to PGD's `bdrdb` database:

```bash
sudo -u postgres psql bdrdb
```

When connected to `bdrdb`, use the following query:

```sql
SELECT * FROM bdr.group_versions_details;
```

The output is similar to this for your cluster:

```
  node_id   | node_name |        postgres_version        | bdr_version 
------------+-----------+--------------------------------+-------------
 3490219809 | kaftan    | 15.5 (Debian 15.5-1EDB.buster) | 5.3.0
 2710197610 | kaboom    | 15.5 (Debian 15.5-1EDB.buster) | 5.3.0
 2111777360 | kaolin    | 15.5 (Debian 15.5-1EDB.buster) | 5.3.0
(3 rows)
```

Confirm that the Postgres version is the expected version. Then, use the `exit` command to return to the node's command prompt.

### Stop Postgres on the target node

If you're not already on the target node, use SSH to connect to the target node (in this case, kaboom), and then run:

```bash
sudo systemctl stop postgres
```

This command halts the server on the current node, in this case, kaboom. Your cluster continues running using the other two nodes.

### Install the new Postgres version

While still on the target node, kaboom, install the new version of Postgres (PG16) and the upgrade tool:

```bash
sudo apt install edb-bdr5-pg16 edb-bdr-utilities
```

### Initialize Postgres 16

Make a new data directory for the upgraded Postgres, and give the postgres user ownership of the directory:

```bash
sudo mkdir /opt/postgres/datanew
sudo chown -R postgres:postgres /opt/postgres/datanew
```

Then, initialize Postgres 16 in the new directory:

```bash
sudo -u postgres /usr/lib/postgresql/16/bin/initdb \
  -D /opt/postgres/datanew \
  -E UTF8 \
  --lc-collate=en_US.UTF-8 \
  --lc-ctype=en_US.UTF-8 \
  --data-checksums
```

This command creates a PG16 data directory for configuration, `/opt/postgres/datanew`.

### Copy configuration for Postgres 15 to Postgres 16

The next step copies the existing configuration (PG15) to the new PG16 data directory.

Copy over the `postgresql.conf`, `postgresql.auto.conf`, and `pg_hba.conf` files and the whole `conf.d` directory:

```bash
sudo -u postgres cp /opt/postgres/data/postgresql.conf /opt/postgres/datanew/
sudo -u postgres cp /opt/postgres/data/postgresql.auto.conf /opt/postgres/datanew/
sudo -u postgres cp /opt/postgres/data/pg_hba.conf /opt/postgres/datanew/
sudo -u postgres cp -r /opt/postgres/data/conf.d/ /opt/postgres/datanew/
```

### Rename the PGDATA directories

Next, swap the PG15 and PG16 data directories: 

```bash
sudo mv /opt/postgres/data /opt/postgres/dataold
sudo mv /opt/postgres/datanew /opt/postgres/data
```

!!! Important
If something goes wrong at some point during the procedure, you may want to rollback/revert a node to the older major version. To do this, rename directories again so that the current data directory, `/opt/postgres/data`, becomes `/opt/postgres/datafailed` and the old data directory, `/opt/postgres/dataold`, becomes the current data directory:

```bash
sudo mv /opt/postgres/data /opt/postgres/datafailed
sudo mv /opt/postgres/dataold /opt/postgres/data
```

This rolls back/reverts the node back to the previous major version of Postgres.
!!!

### Stop all Postgres instances

Although you previously stopped the Postgres service on the target node, kaboom, to be sure it's stopped, run the `stop` command for both instances of Postgres (PG15 and PG16) on
kaboom:

```bash
sudo -u postgres /usr/lib/postgresql/15/bin/pg_ctl -D /opt/postgres/dataold stop
sudo -u postgres /usr/lib/postgresql/16/bin/pg_ctl -D /opt/postgres/data stop
```

!!! Note
When running the first or second command to stop the Postgres instances, you may receive the following error:

```bash
pg_ctl: PID file "/opt/postgres/data/postmaster.pid" does not exist
Is server running?
```
This error is expected when both instances of Postgres are already shut down. Therefore, it doesn't prevent the upgrade from progressing.
!!!

### Check that you can upgrade safely

The `bdr_pg_upgrade` tool has a `--check` option, which performs a dry run of some of the upgrade process. You can use this option to ensure the upgrade goes smoothly.

However, first you need a directory for the files created by `bdr_pg_upgrade`. For this example, create an `/upgrade` directory in the `/home` directory. Then give ownership of the directory to the user postgres. 

```bash
sudo mkdir /home/upgrade
sudo chown postgres:postgres /home/upgrade
```

Next, navigate to `/home/upgrade` and run:

```bash
sudo -u postgres /usr/bin/bdr_pg_upgrade \
  --old-bindir /usr/lib/postgresql/15/bin/ \
  --new-bindir /usr/lib/postgresql/16/bin/ \
  --old-datadir /opt/postgres/dataold/ \
  --new-datadir /opt/postgres/data/ \
  --database bdrdb \
  --check
```

The following is the output:

```
Performing BDR Postgres Checks
------------------------------
Collecting pre-upgrade new cluster control data             ok
Checking new cluster state is shutdown                      ok
Checking BDR versions                                       ok

Passed all bdr_pg_upgrade checks, now calling pg_upgrade

Performing Consistency Checks
-----------------------------
Checking cluster versions                                   ok
Checking database user is the install user                  ok
Checking database connection settings                       ok
Checking for prepared transactions                          ok
Checking for system-defined composite types in user tables  ok
Checking for reg* data types in user tables                 ok
Checking for contrib/isn with bigint-passing mismatch       ok
Checking for presence of required libraries                 ok
Checking database user is the install user                  ok
Checking for prepared transactions                          ok
Checking for new cluster tablespace directories             ok

*Clusters are compatible
```

!!! Note
If you didn't initialize Postgres 16 with checksums using the `--data-checksums` option, an error tells you about the incompatibility:

```bash
old cluster uses data checksums but the new one does not
```
!!!

### Run the Postgres major version upgrade

You're ready to run the upgrade. On the target node, run:

```bash
sudo -u postgres /usr/bin/bdr_pg_upgrade \
  --old-bindir /usr/lib/postgresql/15/bin/ \
  --new-bindir /usr/lib/postgresql/16/bin/ \
  --old-datadir /opt/postgres/dataold/ \
  --new-datadir /opt/postgres/data/ \
  --database bdrdb
```

The following is the output:

```
Performing BDR Postgres Checks
------------------------------
Collecting pre-upgrade new cluster control data             ok
Checking new cluster state is shutdown                      ok
Checking BDR versions                                       ok
Starting old cluster (if shutdown)                          ok
Connecting to old cluster                                   ok
Checking if bdr schema exists                               ok
Turning DDL replication off                                 ok
Terminating connections to database                         ok
Disabling connections to database                           ok
Waiting for all slots to be flushed                         ok
Disconnecting from old cluster                              ok
Stopping old cluster                                        ok
Starting old cluster with BDR disabled                      ok
Connecting to old cluster                                   ok
Collecting replication origins                              ok
Collecting replication slots                                ok
Disconnecting from old cluster                              ok
Stopping old cluster                                        ok

Passed all bdr_pg_upgrade checks, now calling pg_upgrade

Performing Consistency Checks
-----------------------------
Checking cluster versions                                   ok
Checking database user is the install user                  ok
Checking database connection settings                       ok
Checking for prepared transactions                          ok
Checking for system-defined composite types in user tables  ok
Checking for reg* data types in user tables                 ok
Checking for contrib/isn with bigint-passing mismatch       ok
Creating dump of global objects                             ok
Creating dump of database schemas                           ok
Checking for presence of required libraries                 ok
Checking database user is the install user                  ok
Checking for prepared transactions                          ok
Checking for new cluster tablespace directories             ok

If pg_upgrade fails after this point, you must re-initdb the
new cluster before continuing.

Performing Upgrade
------------------
Analyzing all rows in the new cluster                       ok
Freezing all rows in the new cluster                        ok
Deleting files from new pg_xact                             ok
Copying old pg_xact to new server                           ok
Setting oldest XID for new cluster                          ok
Setting next transaction ID and epoch for new cluster       ok
Deleting files from new pg_multixact/offsets                ok
Copying old pg_multixact/offsets to new server              ok
Deleting files from new pg_multixact/members                ok
Copying old pg_multixact/members to new server              ok
Setting next multixact ID and offset for new cluster        ok
Resetting WAL archives                                      ok
Setting frozenxid and minmxid counters in new cluster       ok
Restoring global objects in the new cluster                 ok
Restoring database schemas in the new cluster               ok
Copying user relation files                                 ok
Setting next OID for new cluster                            ok
Sync data directory to disk                                 ok
Creating script to delete old cluster                       ok
Checking for extension updates                              notice

Your installation contains extensions that should be updated
with the ALTER EXTENSION command.  The file
    update_extensions.sql
when executed by psql by the database superuser will update
these extensions.


Upgrade Complete
----------------
Optimizer statistics are not transferred by pg_upgrade.
Once you start the new server, consider running:
    /usr/pgsql-15/bin/vacuumdb --all --analyze-in-stages

Running this script will delete the old cluster's data files:
    ./delete_old_cluster.sh

pg_upgrade complete, performing BDR post-upgrade steps
------------------------------------------------------
Collecting old cluster control data                         ok
Collecting new cluster control data                         ok
Checking LSN of new cluster                                 ok
Starting new cluster with BDR disabled                      ok
Connecting to new cluster                                   ok
Creating replication origin (bdr_bdrdb_rb69_bdr2)           ok
Advancing replication origin (bdr_bdrdb_rb69_bdr2, 0/1F4... ok
Creating replication origin (bdr_bdrdb_rb69_bdr1)           ok
Advancing replication origin (bdr_bdrdb_rb69_bdr1, 0/1E8... ok
Creating replication slot (bdr_bdrdb_rb69_bdr1)             ok
Creating replication slot (bdr_bdrdb_rb69)                  ok
Creating replication slot (bdr_bdrdb_rb69_bdr2)             ok
Stopping new cluster
```

### Modify the Postgres service

The Postgres service on the system is configured to start the old version 
of Postgres (PG15). You need to modify the `postgres.service` file to start the new 
version (PG16). You can do this using `sed` to replace the old version
number `15` with `16` throughout the file. 

After you've changed the version number, you can tell the 
systemd daemon to reload the configuration. On the target node, run:

```bash
sudo sed -i -e  's/15/16/g' /etc/systemd/system/postgres.service
sudo systemctl daemon-reload
```

### Start Postgres

Start the modified Postgres service by running:

```bash
sudo systemctl start postgres
```

### Validate the Postgres version

Repeating the first step, check the version of Postgres to confirm that you upgraded kaboom correctly. While still on kaboom, run:

```bash
sudo -u postgres psql bdrdb
```

```sql
SELECT * FROM bdr.group_versions_details;
```

The output is similar to this for your cluster. Use the output to confirm that kaboom is running the upgraded Postgres version. 

```
  node_id   | node_name |        postgres_version        | bdr_version 
------------+-----------+--------------------------------+-------------
 3490219809 | kaftan    | 15.5 (Debian 15.5-1EDB.buster) | 5.3.0
 2710197610 | kaboom    | 16.1 (Debian 16.1-1EDB.buster) | 5.3.0
 2111777360 | kaolin    | 15.5 (Debian 15.5-1EDB.buster) | 5.3.0
(3 rows)
```

### Test the upgrade

After the upgrade is complete on kaboom, test your databases thoroughly to ensure the upgrade was successful. Being still connected to kaboom ensures that your tests run specifically against the new version without interference from cluster routing mechanisms.

```bash
sudo -u postgres psql <database_name>
```

Next, execute your test suite, including application transactions, queries, and other operations critical to your environment. Pay particular attention to performance metrics and compatibility with the new version. The insights gained from this controlled upgrade can inform your approach, helping to ensure a smoother transition for all nodes.

### Clean up post-upgrade

As best practice, run a vacuum over the database at this point. When the upgrade ran, you may have noticed the post-upgrade report included:

```
Once you start the new server, consider running:
    /usr/lib/postgresql/16/bin/vacuumdb --all --analyze-in-stages
```

You can run the vacuum now. On the target node, run:

```bash
sudo -u postgres /usr/lib/postgresql/16/bin/vacuumdb --all --analyze-in-stages
```

If you're sure you don't need to revert this node, you can also clean up the old data directory folder `dataold`:

```bash
sudo rm -r /opt/postgres/dataold
```

### Next steps

After completing the upgrade on kaboom, run the same steps to upgrade the other shadow node, namely kaolin.

After kaolin, only kaftan needs to be upgraded. However, because kaftan is the write leader, perform a planned switchover before running the upgrade steps on the node to ensure availability.

#### Performing a planned switchover

When you're ready to upgrade kaftan, SSH into kaftan and switch over the write leader from kaftan to an already upgraded shadow node, for example, kaboom:

```bash
sudo -u postgres pgd switchover --group-name dc1_subgroup --node-name kaboom
```

Then, run `pgd show-groups` to ensure the switchover was successful.

```bash
sudo -u postgres pgd show-groups
```

You can see that kaboom is now the write leader:

```
Group        Group ID   Type   Parent Group Location Raft Routing Write Leader 
-----        --------   ----   ------------ -------- ---- ------- ------------ 
democluster  1935823863 global                       true false                
dc1_subgroup 1302278103 data   democluster  dc1      true true    kaboom  
```

It's now safe to upgrade kaftan using the same steps you used on the shadow nodes.

#### Check PG versions across the cluster 

After completing the upgrade on all nodes, while connected to one of the nodes, you can once again check your versions in the PGD database:

```bash
sudo -u postgres psql bdrdb
```

Then run the SQL query:

```sql
SELECT * FROM bdr.group_versions_details;
```

The output is similar to the following:

```
  node_id   | node_name |        postgres_version        | bdr_version 
------------+-----------+--------------------------------+-------------
 3490219809 | kaftan    | 16.1 (Debian 16.1-1EDB.buster) | 5.3.0
 2710197610 | kaboom    | 16.1 (Debian 16.1-1EDB.buster) | 5.3.0
 2111777360 | kaolin    | 16.1 (Debian 16.1-1EDB.buster) | 5.3.0
(3 rows)
```

This output shows that all the nodes were successfully upgraded to the new Postgres version.

#### Reconcile with TPA

After all the nodes are upgraded, you still need to [reconcile](https://www.enterprisedb.com/docs/tpa/latest/reference/reconciling-local-changes/) the upgraded version of Postgres with TPA so you can continue to use TPA to manage the cluster in the future.

To do this, return to the command line where your TPA cluster directory resides. In this worked example, the TPA cluster directory is `/home/ubuntu/democluster` on the instance where you originally deployed the cluster using TPA.

After navigating to your cluster directory, use a code editor to edit `config.yml` and change `cluster_vars:` from `postgres_version: '15'` to `postgres_version: '16'`.

Unless they were already added to your `.bashrc` or `.bash_profile`, ensure the TPA tools are accessible in your command line session by adding TPA's binary directory to your PATH:

```bash
export PATH=$PATH:/opt/EDB/TPA/bin
```
Finally, redeploy the cluster:

```bash
tpaexec deploy democluster
```

This command applies the configuration changes to the cluster managed by TPA. If the deployment is successful, the reconciliation of the new version of Postgres with TPA and the upgrade procedure as a whole is complete.
