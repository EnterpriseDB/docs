---
title: Private Endpoint example
---

These are the steps to connect using Azure Private Endpoint. 

Assume that your cluster is on a subscription called `development` and is being accessed from a Linux client VM on another subscription `test` with the following properties:

- Cluster:
  - Subscription: `development`
  - Cluster ID: `p-c4j0jfcmp3af2ieok5eg` 
  - Account ID: `brcxzr08qr7rbei1` 
  - Organization's domain name: `example.io` 


- Linux client VM called `vm-client`:
  - Subscription: `test`
  - Resource group: `rg-client`
  - Virtual network: `vnet-client`
  - Virtual network subnet: `snet-client`

#### Prerequisites

To walk through an example in your own environment, you need:

- Your cluster URL. You can find the URL in the **Connect** tab of your cluster instance in the EDB Cloud portal.
 
- IP address of your cluster. You can find the IP address of your cluster using the following command:

 ```
 $ dig +short p-c4j0jfcmp3af2ieok5eg.brcxzr08qr7rbei1.example.io 
 10.240.1.218
 ```
 
- A Postgresql client, such as [psql](https://www.postgresql.org/download/), installed on your client VM.

#### Step 1: Create an Azure Private Link service for your cluster
 
  In this example, you will create an [Azure Private Link service](https://docs.microsoft.com/en-us/azure/private-link/private-link-service-overview) in your cluster resource group. You must perform this procedure for every cluster that you want to connect to in Azure.

  1. Get the resource group details from the Azure CLI or the Azure portal and note down the resource group name. For example, if the cluster's virtual network is `vnet-japaneast`, use the following command: 
 
     ```
       $ az network vnet list --query "[?name==\'vnet-japaneast\'].resourceGroup" -o json

     ```
  
  1. On the upper-left part of the page in the Azure portal, select **Create a resource**.
  
  1. Search for **Private Link** in the **Search the Marketplace** box.

  1. Click **Create**.

  1. Enter the details for the private link service. Use a unique name for the private link service. 
   
   For example, `p-c4j0jfcmp3af2ieok5eg-service-private-link`, where `p-c4j0jfcmp3af2ieok5eg` is the cluster ID. 
    
    ![Create private link service](../images/image5.png)

  1. Enter the resource group name obtained in step 1. 

  3. In the **Outbound settings** page, select the `kubernetes-internal` load balancer
    and select the IP address of your cluster in the **Load balancer frontend IP
    address**.

     ![Outbound settings](../images/image1.png)

  4. On the **Access security** page, configure the level of access for the private link service. See [control service exposure](https://docs.microsoft.com/en-us/azure/private-link/private-link-service-overview#control-service-exposure) for details.
  
   ![](../images/image21.png)  

   !!! Note
       If the required access is not provided to the account or subscription accessing the cluster, you must manually approve the connection request from the **Pending connections** page in **Private Link Center**.
   

  5. After the private link Service is created, note down its *alias*. The *alias* is the unique ID for your private service, which can be shared with the service consumers. Obtain the *alias* either from the Azure portal or by the using the following CLI command:

     ```
       $ az network private-link-service list --query "[?name=='p-c4j0jfcmp3af2ieok5eg-service-private-link'].alias" -o tsv
       p-c4j0jfcmp3af2ieok5eg-service-private-link.48f26b42-45dc-4e80-8e3d-307d58d7d274.japaneast.azure.privatelinkservice
     ```

  6. Select **Review + Create**.

  7. Select **Create**.

#### Step 2: Create an Azure Private Endpoint in each client virtual network

  In this example, you will create an Azure Private Endpoint in the client VM virtual network. After you have created the private endpoint, you can use its private IP address to access the cluster. You must perform this procedure for every client application in Azure.
  
  1. On the upper-left side of the screen in the portal, select **Create a resource > Networking > Private Link** or in the search box enter **Private Link**.
  
  1. Select **Create**.

  1. In Private Link Center, select **Private endpoints** in the menu on the left.

  1. In Private endpoints, click **Create**.

  1. Enter the details for the private endpoint as shown in the following screenshot. Use a unique name for the private endpoint. 
   
   For example, `vnet-client-private-pg-service`, where `vnet-client` is the client VNet ID. 
   
   !!! Note
       In a later step, you will require the private endpoint's name to get its private IP address.
   
   ![](../images/image12.png)

  1. Connect the private endpoint to the private link service that we created by entering its *alias*.

   ![](../images/image17.png)

  1. In the **Configuration** page, enter the client VM's Virtual Network `vnet-client`.

  1. Select **Review + Create**.

  7. Select **Create**.
   
   !!! Note
      If the private endpoint's status appears as **Pending**, your account or subscription might not be authorized to access the private link service. 
  
      To resolve this issue, the connection must be manually approved from the **Pending connections** page in **Private Link Center**, from the EDB Cloud Azure subscription.

      ![](../images/image3.png)


11. You have now successfully built a tunnel between your client VM's virtual network and the cluster. You can now access the cluster from the private endpoint in you client VM. The private endpoint's private IP address is associated with an independent virtual network NIC. Use the following scripts to get the private endpoint's private IP address:
   
   Get the private endpoint's private IP address using the following scripts:

 ```
  $ NICID=$(az network private-endpoint show -n vnet-client-private-pg-service -g rg-client --query "networkInterfaces[0].id" -o tsv)
  $ az network nic show -n ${NICID##*/} -g rg-client --query "ipConfigurations[0].privateIpAddress" -o tsv
  100.64.111.5
 ``` 

12. From the client VM `vm-client`, access the cluster by using the private IP address.

 ```
 $ psql -h 100.64.111.5 -0 edb_admin 
 
 Password for user edb_admin : 
 
 psql (13.4 (Ubuntu 13.4-1.pgdg20.04+1), server 13.4.8 (Debian 13.4.8-1+deb10)) 
 WARNING : psql major version 13, server major version 13. Some psql features might not work. 
 SSL connection (protocol : TLSV1.3, cipher : TLS_AES_256_GCM_SHA384, bits : 256, compression : off) Type "help" for help. 
 
 edb_admin=>

 ```

#### Step 3: Create an Azure Private DNS Zone for the private endpoint

EDB strongly recommends using an [Azure Private DNS Zone](https://docs.microsoft.com/en-us/azure/dns/private-dns-privatednszone) with the private endpoint to establish a connection with a cluster, because it is not possible to validate TLS certificates using `verify-full` when connecting to an IP address. 

You will configure a DNS entry for your cluster's public hostname, and Azure DNS will ensure that all requests to that domain name from your VNet resolve to the private endpoint's IP address instead of the cluster's IP address.

!!! Note
     You need to create a single Azure Private DNS Zone for each VNet, even if you are connecting to multiple clusters.
    

1. In the Azure portal search bar, enter "Private DNS Zones" in the search text box and press Enter.
 
1. Click **Private DNS zone**.

1. Click **Create private DNS zone**.

1. Create a private DNS zone using your organization's domain name as an apex domain. The organization's domain name must be unique to your EDB Cloud organization. For example `example.io`.
 
 ![](../images/image6.png)

1. Select the **Virtual network** link on the **Private DNS Zone** page of `brcxzr08qr7rbei1.example.io` and link the private DNS Zone to the client VM's virtual network
`vnet-client`.

 ![](../images/image10.png)

1. Add a new record for the private endpoint. The address is a private IP address - the one created with the private endpoint in the previous step.

 ![](../images/image4.png)

1. You can now access your cluster with this private domain name.

 ```
 $ dig +short p-c4iabjleig4@jngmac48.brcxzr08qr7rbei1.example.io 
 10.240.1.123 
       
 $ psql -h p-c41a6jleig4@jngmac48.brcxzr08qr7rbei1.example.io -u edh_admin      
 Password for user edb_admin: 
 
 psql (13.4 (Ubuntu 13.4-1.pgdg28.84+1), server 13.4.8 (Debian 13.4.8-1+deb10)) 
 WARNING : psql major version 13, server major version 13. Some psql features might not work. 
 SSL connection (protocol : TLSV1.3cipherTLS_AES_256_GCM_SHA384, bits : 256, compression : off) Type "help" for help. 
 
 edb_admins=>
 
 ```

 !!! Tip
    You might need to flush your local DNS cache, to resolve your domain name to the new private IP address after adding the private endpoint. For example, on Ubuntu run the following command:

  ```
  $ sudo systemd-resolve --flush-caches
  ```
