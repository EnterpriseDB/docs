---
title: Creating a cluster programatically
navTitle: Creating clusters programatically
description: Create a cluster from the command line using the API
---

You can create a database cluster using bash and the Hybrid Manager API.

## Creating a machine user

Be sure to first create a machine user and to capture the machine user's HCP access key ("baak_...")

1. Click on the dropdown menu in the upper-right corner.
2. Select **User management** from the dropdown menu.
3. Click **Add new user** in the upper-right corner.
4. In the pop-up window that shows **Add new user**, enter the name and tick off the checkbox **Create access key**.
6. Fill in the field **Expires in**.
7. In the pop-up window that shows **Add new user**, click **Add user**.
8. Copy the access key from the pop-up window.
9. Click **Key stored safely**.

Give the machine user permissions.

1. In the upper naviigation pane, click **Projects** and navigate to your project.
  (we need to have your project "in context" before assigning permissions
   to the machine user you just created)
2. In the left navigation pane, click **Users**.
3. Search for the machine user you created.
4. Click the pencil (edit) icon next to the user.
5. Click **Assign Roles** in the upper right.
6. Check the permissions in **Owner**.
7. Click **Submit**.

## Creating an env.sh file

Add the copied access key in a file named `env.sh`.
It will look like this:

```
export HCP_ACCESS_KEY="baak_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
export HCP_API_ACCESS_KEY=${HCP_ACCESS_KEY}
export HCP_PROJECT_ID=prj_xxxxxxxxxxxxxx
export HCP_API_HOST="https://portal-uat-eks.aws.hcp.enterprisedb.network"
```

Adding our project ID in the `env.sh`file and the API host makes writing shell scripts easier.

## Getting locations to find a Docker image with AIDB and PGFS

Contents of a file named `01-get-locations.sh`:

```
#!/bin/bash

set -e
set -u
set -o pipefail

# list locations

source env.sh

curl \
  --insecure \
  --header "Content-Type: Application/JSON" \
  --header "x-access-key: ${HCP_API_ACCESS_KEY}" \
  --request GET \
  ${HCP_API_HOST}/api/v1/projects/${HCP_PROJECT_ID}/locations \
  | jq
```

Run the following file to get a list of locations and the Docker images available at the locations:

```
$ ./01-get-locations.sh > locations.json
```

Look in `locations.json` for any image listed under `pgExtensions`, `aidb` and `pgfs`.

## Creating a Postgres cluster

Add the image to the file `create-psr-cluster.json`:

```
{
  "projectId": "${HCP_PROJECT_ID}",
  "psr": {
    "clusterName": "small-ai-api-001",
    "password": "111111111111",
    "locationId": "managed-devspatcher",
    "clusterData": {
      "instances": 1,
      "resourceRequest": {
        "memory": "2Gi",
        "cpu": "2"
      },
      "storageConfiguration": {
        "primaryStorage": {
          "size": "4",
          "storageClass": "hcp-aws-gp3"
        },
        "walStorage": {
          "size": "4",
          "storageClass": "hcp-aws-gp3"
        }
      },
      "image": {
        "url": "upmdev.azurecr.io/postgresql:17.6-2510160831",
        "digest": "sha256:6bda61e6d75c3b9d6a886c547d789c46b88ed807ae28d8d06fa1510a0cc5afae"
      },
      "networkAccessType": "NetworkAccessTypePublic"
    }
  }
}
```

Write a shell script called `02-create-psr-cluster.sh` to use `create-psr-cluster.json` and create a cluster:

```
#!/bin/bash

set -e
set -o pipefail
set -u

source env.sh

cat create-psr-cluster.json | envsubst > /tmp/create-psr-cluster.json

curl \
  --insecure \
  --header "Content-Type: Application/JSON" \
  --header "x-access-key: ${HCP_API_ACCESS_KEY}" \
  --data-binary "@/tmp/create-psr-cluster.json" \
  --request POST \
  ${HCP_API_HOST}/api/v1/projects/${HCP_PROJECT_ID}/clusters
```

Run the shell script:

```
$ ./02-create-psr-cluster.sh | tee ./psr-cluster.json
```

You can check the progress of the cluster creation in the web UI.

## Creating the AIDB and PGFS extensions in your new cluster

### Enhancing env.sh with PSQL login credentials

Add the following to your `env.sh` file:

```
export PGPASSWORD=xxxxxxxxxxxxxxxxxxx
export PGUSER=edb_admin
export PGHOST=p-fj3ki6e0x0-a-rw-external-f068986a6830d743.elb.us-east-1.amazonaws.com
export PGPORT=5432
export PGDATABASE=edb_admin
export PGSSLMODE=require
```

Create a bash file called `03-create-ai-extensions.sh` with the following content:

```
#!/bin/bash

set -e
set -o pipefail
set -u

source env.sh

psql -X <<EOF
create extension aidb cascade;
create extension pgfs cascade;
EOF

```

Run the file:

```
$ chmod +x 03-create-ai-extensions.sh
$ ./03-create-ai-extensions.sh
```

### Now go to step 4



# APPENDIX

## Best practices

### Dumping a JSON file in a cluster created in the web UI

The contents of `get-existing-cluster.sh`:

```
#!/bin/bash

set -e
set -u
set -o pipefail

source env.sh

HCP_PG_CLUSTER_ID=p-fj3ki6e0x0

curl \
  --insecure \
  --header "Content-Type: Application/JSON" \
  --header "x-access-key: ${HCP_API_ACCESS_KEY}" \
  --request GET \
  ${HCP_API_HOST}/api/v1/projects/${HCP_PROJECT_ID}/clusters/${HCP_PG_CLUSTER_ID} \
  | jq
```

Generate a JSON dump of this cluster:

```
$ ./get-existing-cluster.sh > existing-cluster.json
```

### Checking the API docs

At the bottom of almost every page in the Web UI is an API link. Click on the link
and then search in the resulting page for **CreateCluster**. This clarifies the required fields, the naming convention, and the nesting hierarchy of the cluster creation JSON.

