---

title: "DBMS_AQ"
---

<div id="dbms_aq" class="registered_link"></div>

EDB Postgres Advanced Server Advanced Queueing provides message queueing and message processing for the Advanced Server database. User-defined messages are stored in a queue; a collection of queues is stored in a queue table. Procedures in the DBMS_AQADM package create and manage message queues and queue tables. Use the DBMS_AQ package to add messages to a queue or remove messages from a queue, or register or unregister a PL/SQL callback procedure.

Advanced Server also provides extended (non-compatible) functionality for the DBMS_AQ package with SQL commands. Please see the *Database Compatibility for Oracle Developers Reference Guide* for detailed information about the following SQL commands:

- `ALTER QUEUE`
- `ALTER QUEUE TABLE`
- `CREATE QUEUE`
- `CREATE QUEUE TABLE`
- `DROP QUEUE`
- `DROP QUEUE TABLE`

The DBMS_AQ  package provides procedures that allow you to enqueue a message, dequeue a message, and manage callback procedures. The supported procedures are:

| Function/Procedure | Return Type | Description                                                  |
| ------------------ | ----------- | ------------------------------------------------------------ |
| `ENQUEUE`          | n/a         | Post a message to a queue.                                   |
| `DEQUEUE`          | n/a         | Retrieve a message from a queue if or when a message is available. |
| `REGISTER`         | n/a         | Register a callback procedure.                               |
| `UNREGISTER`       | n/a         | Unregister a callback procedure.                             |

Advanced Server's implementation of DBMS_AQ is a partial implementation when compared to Oracle's version. Only those procedures listed in the table above are supported.

Advanced Server supports use of the constants listed below:

| Constant                          | Description                                                  | For Parameters                                               |
| --------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| `DBMS_AQ.BROWSE (0)`              | Read the message without locking.                            | `dequeue_options_t.dequeue_mode`                             |
| `DBMS_AQ.LOCKED (1)`              | This constant is defined, but will return an error if used.  | `dequeue_options_t.dequeue_mode`                             |
| `DBMS_AQ.REMOVE (2)`              | Delete the message after reading; the default.               | `dequeue_options_t.dequeue_mode`                             |
| `DBMS_AQ.REMOVE_NODATA (3)`       | This constant is defined, but will return an error if used.  | `dequeue_options_t.dequeue_mode`                             |
| `DBMS_AQ.FIRST_MESSAGE (0)`       | Return the first available message that matches the search terms. | `dequeue_options_t.navigation`                               |
| `DBMS_AQ.NEXT_MESSAGE (1)`        | Return the next available message that matches the search terms. | `dequeue_options_t.navigation`                               |
| `DBMS_AQ.NEXT_TRANSACTION (2)`    | This constant is defined, but will return an error if used.  | `dequeue_options_t.navigation`                               |
| `DBMS_AQ.FOREVER (0)`             | Wait forever if a message that matches the search term is not found, the default. | `dequeue_options_t.wait`                                     |
| `DBMS_AQ.NO_WAIT (1)`             | Do not wait if a message that matches the search term is not found. | `dequeue_options_t.wait`                                     |
| `DBMS_AQ.ON_COMMIT (0)`           | The dequeue is part of the current transaction.              | `enqueue_options_t.visibility, dequeue_options_t.visibility` |
| `DBMS_AQ.IMMEDIATE (1)`           | This constant is defined, but will return an error if used.  | `enqueue_options_t.visibility, dequeue_options_t.visibility` |
| `DBMS_AQ.PERSISTENT (0)`          | The message should be stored in a table.                     | `enqueue_options_t.delivery_mode`                            |
| `DBMS_AQ.BUFFERED (1)`            | This constant is defined, but will return an error if used.  | `enqueue_options_t.delivery_mode`                            |
| `DBMS_AQ.READY (0)`               | Specifies that the message is ready to process.              | `message_properties_t.state`                                 |
| `DBMS_AQ.WAITING (1)`             | Specifies that the message is waiting to be processed.       | `message_properties_t.state`                                 |
| `DBMS_AQ.PROCESSED (2)`           | Specifies that the message has been processed.               | `message_properties_t.state`                                 |
| `DBMS_AQ.EXPIRED (3)`             | Specifies that the message is in the exception queue.        | `message_properties_t.state`                                 |
| `DBMS_AQ.NO_DELAY (0)`            | This constant is defined, but will return an error if used   | `message_properties_t.delay`                                 |
| `DBMS_AQ.NEVER (NULL)`            | This constant is defined, but will return an error if used   | `message_properties_t.expiration`                            |
| `DBMS_AQ.NAMESPACE_AQ (0)`        | Accept notifications from DBMS_AQ queues.                    | `sys.aq$_reg_info.namespace`                                 |
| `DBMS_AQ.NAMESPACE_ANONYMOUS (1)` | This constant is defined, but will return an error if used   | `sys.aq$_reg_info.namespace`                                 |

The DBMS_AQ configuration parameters listed in the following table can be defined in the `postgresql.conf` file. After the configuration parameters are defined, you can invoke the DBMS_AQ package to use and manage messages held in queues and queue tables.

| Parameter                     | Description                                                  |
| ----------------------------- | ------------------------------------------------------------ |
| `dbms_aq.max_workers`         | The maximum number of workers to run.                        |
| `dbms_aq.max_idle_time`       | The idle time a worker must wait before exiting.             |
| `dbms_aq.min_work_time`       | The minimum time a worker can run before exiting.            |
| `dbms_aq.launch_delay`        | The minimum time between creating workers.                   |
| `dbms_aq.batch_size`          | The maximum number of messages to process in a single transaction. The default batch size is 10. |
| `dbms_aq.max_databases`       | The size of DBMS_AQ’s hash table of databases. The default value is 1024. |
| `dbms_aq.max_pending_retries` | The size of DBMS_AQ’s hash table of pending retries. The default value is 1024. |

## ENQUEUE

The `ENQUEUE` procedure adds an entry to a queue. The signature is:

> `ENQUEUE(`
>  *`queue_name`* `IN VARCHAR2,`
>  *`enqueue_options`* `IN DBMS_AQ.ENQUEUE_OPTIONS_T,`
>  *`message_properties`* `IN DBMS_AQ.MESSAGE_PROPERTIES_T,`
>  *`payload`* `IN <`*`type_name`*`>,`
>  *`msgid`* `OUT RAW)`

**Parameters**

*`queue_name`*

> The name (optionally schema-qualified) of an existing queue. If you omit the schema name, the server will use the schema specified in the `SEARCH_PATH`. Please note that unlike Oracle, unquoted identifiers are converted to lower case before storing. To include special characters or use a case-sensitive name, enclose the name in double quotes.
>
> For detailed information about creating a queue, please see `DBMS_AQADM.CREATE_QUEUE`.

*`enqueue_options`*

> *enqueue_options* is a value of the type, `enqueue_options_t`:
>
> `DBMS_AQ.ENQUEUE_OPTIONS_T IS RECORD(`
>   `visibility BINARY_INTEGER DEFAULT ON_COMMIT,`
>   `relative_msgid RAW(16) DEFAULT NULL,`
>   `sequence_deviation BINARY INTEGER DEFAULT NULL,`
>   `transformation VARCHAR2(61) DEFAULT NULL,`
>   `delivery_mode PLS_INTEGER NOT NULL DEFAULT PERSISTENT);`
>
> Currently, the only supported parameter values for `enqueue_options_t`  are:
>
> | `visibility`         | `ON_COMMIT.` |
> | -------------------- | ------------ |
> | `delivery_mode`      | `PERSISTENT` |
> | `sequence_deviation` | `NULL`       |
> | `transformation`     | `NULL`       |
> | `relative_msgid`     | `NULL`       |

*`message_properties`*

>    *`message_properties`* is a value of the type, message*_*properties*_*t:
>
>    `message_properties_t IS RECORD(`
>     `priority INTEGER,`
>     `delay INTEGER,`
>     `expiration INTEGER,`
>     `correlation CHARACTER VARYING(128) COLLATE pg_catalog.”C”,`
>     `attempts INTEGER,`
>     `recipient_list “AQ$_RECIPIENT_LIST_T”,`
>     `exception_queue CHARACTER VARYING(61) COLLATE pg_catalog.”C”,`
>     `enqueue_time TIMESTAMP WITHOUT TIME ZONE,`
>   `state INTEGER,`
>   `original_msgid BYTEA,`
>   `transaction_group CHARACTER VARYING(30) COLLATE pg_catalog.”C”,`
>   `delivery_mode INTEGER`
>
> ​    `DBMS_AQ.PERSISTENT);`
>
> The supported values for `message_properties_t` are:
>
> | `priority`          | If the queue table definition includes a `sort_list` that references `priority`, this parameter affects the order that messages are dequeued. A lower value indicates a higher dequeue priority. |
> | ------------------- | ------------------------------------------------------------ |
> | `delay`             | Specify the number of seconds that will pass before a message is available for dequeueing or `NO_DELAY`. |
> | `expiration`        | Use the expiration parameter to specify the number of seconds until a message expires. |
> | `correlation`       | Use correlation to specify a message that will be associated with the entry; the default is `NULL`. |
> | `attempts`          | This is a system-maintained value that specifies the number of attempts to dequeue the message. |
> | `recipient_list`    | This parameter is not supported.                             |
> | `exception_queue`   | Use the `exception_queue` parameter to specify the name of an exception queue to which a message will be moved if it expires or is dequeued by a transaction that rolls back too many times. |
> | `enqueue_time`      | `enqueue_time` is the time the record was added to the queue; this value is provided by the system. |
> | `state`             | This parameter is maintained by DBMS_AQ; state can be: `DBMS_AQ.WAITING` – the delay has not been reached. `DBMS_AQ.READY` – the queue entry is ready for processing. `DBMS_AQ.PROCESSED` – the queue entry has been processed. `DBMS_AQ.EXPIRED` – the queue entry has been moved to the exception queue. |
> | `original_msgid`    | This parameter is accepted for compatibility and ignored.    |
> | `transaction_group` | This parameter is accepted for compatibility and ignored.    |
> | `delivery_mode`     | This parameter is not supported; specify a value of `DBMS_AQ.PERSISTENT`. |

*`payload`*

> Use the *`payload`* parameter to provide the data that will be associated with the queue entry. The payload type must match the type specified when creating the corresponding queue table (see `DBMS_AQADM.CREATE_QUEUE_TABLE`).

*`msgid`*

> Use the *`msgid`* parameter to retrieve a unique (system-generated) message identifier.



**Example**

> The following anonymous block calls DBMS_AQ.ENQUEUE, adding a message to a queue named work_order:

```
DECLARE

  enqueue_options    DBMS_AQ.ENQUEUE_OPTIONS_T;
  message_properties DBMS_AQ.MESSAGE_PROPERTIES_T;
  message_handle     raw(16);
  payload            work_order;

BEGIN

  payload := work_order('Smith', 'system upgrade');

DBMS_AQ.ENQUEUE(
  queue_name         => 'work_order',
  enqueue_options    => enqueue_options,
  message_properties => message_properties,
  payload            => payload,
  msgid              => message_handle
    );
 END;
```

## DEQUEUE

The `DEQUEUE` procedure dequeues a message. The signature is:

> `DEQUEUE(`
>  *`queue_name`* `IN VARCHAR2,`
>   `dequeue_options` `IN DBMS_AQ.DEQUEUE_OPTIONS_T,`
>  *`message_properties`* `OUT DBMS_AQ.MESSAGE_PROPERTIES_T,`
>  *payload* `OUT` *`type_name`*,
>  *`msgid`* `OUT RAW)`

**Parameters**

*`queue_name`*

> The name (optionally schema-qualified) of an existing queue. If you omit the schema name, the server will use the schema specified in the `SEARCH_PATH`. Please note that unlike Oracle, unquoted identifiers are converted to lower case before storing. To include special characters or use a case-sensitive name, enclose the name in double quotes.
>
> For detailed information about creating a queue, please see `DBMS_AQADM.CREATE_QUEUE`.

*`dequeue_options`*

> *`dequeue options`* is a value of the type, `dequeue_options_t:`
>
> `DEQUEUE_OPTIONS_T` `IS RECORD(`
>   `consumer_name CHARACTER VARYING(30),`
>   `dequeue_mode INTEGER,`
>   `navigation INTEGER,`
>   `visibility INTEGER,`
>   `wait INTEGER,`
>   `msgid BYTEA,`
>   `correlation CHARACTER VARYING(128),`
>   `deq_condition CHARACTER VARYING(4000),`
>   `transformation CHARACTER VARYING(61),`
>   `delivery_mode INTEGER);`

Currently, the supported parameter values for `dequeue_options_t`  are:

| `consumer_name`  | Must be `NULL`.                                              |
| ---------------- | ------------------------------------------------------------ |
| `dequeue_mode`   | The locking behavior of the dequeue operation. Must be either: <br/>`DBMS_AQ.BROWSE` – Read the message without obtaining a lock. `DBMS_AQ.LOCKED` – Read the message after acquiring a lock. `DBMS_AQ.REMOVE` – Read the message before deleting the message. `DBMS_AQ.REMOVE_NODATA` – Read the message, but do not delete the message. |
| `navigation`     | Identifies the message that will be retrieved. Must be either: <br/>`FIRST_MESSAGE` – The first message within the queue that matches the search term. <br/>`NEXT_MESSAGE` – The next message that is available that matches the first term. |
| `visibility`     | Must be `ON_COMMIT` – if you roll back the current transaction the dequeued item will remain in the queue. |
| `wait`           | Must be a number larger than 0, or: <br/>`DBMS_AQ.FOREVER` – Wait indefinitely. <br/>`DBMS_AQ.NO_WAIT` – Do not wait. |
| `msgid`          | The message ID of the message that will be dequeued.         |
| `correlation`    | Accepted for compatibility, and ignored.                     |
| `deq_condition`  | A `VARCHAR2` expression that evaluates to a `BOOLEAN` value, indicating if the message should be dequeued. |
| `transformation` | Accepted for compatibility, and ignored.                     |
| `delivery_mode`  | Must be `PERSISTENT`; buffered messages are not supported at this time. |

*`message_properties`*

>   *`message_properties`* is a value of the type, message*_*properties*_*t:
>
>   `message_properties_t IS RECORD(`
>  `priority INTEGER,`
>     `delay INTEGER,`
>     `expiration INTEGER,`
>     `correlation CHARACTER VARYING(128) COLLATE pg_catalog.”C”,`
>     `attempts INTEGER,`
>     `recipient_list “AQ$_RECIPIENT_LIST_T”,`
>     `exception_queue CHARACTER VARYING(61) COLLATE pg_catalog.”C”,`
>     `enqueue_time TIMESTAMP WITHOUT TIME ZONE,`
>     `state INTEGER,`
>     `original_msgid BYTEA,`
>     `transaction_group CHARACTER VARYING(30) COLLATE pg_catalog.”C”,`
>     `delivery_mode INTEGER`
>
>   `DBMS_AQ.PERSISTENT);`
>
> > The supported values for message_properties_t are:
> >
> > | `priority`          | If the queue table definition includes a `sort_list` that references `priority`, this parameter affects the order that messages are dequeued. A lower value indicates a higher dequeue priority. |
> > | ------------------- | ------------------------------------------------------------ |
> > | `delay`             | Specify the number of seconds that will pass before a message is available for dequeueing or `NO_DELAY`. |
> > | `expiration`        | Use the expiration parameter to specify the number of seconds until a message expires. |
> > | `correlation`       | Use correlation to specify a message that will be associated with the entry; the default is `NULL`. |
> > | `attempts`          | This is a system-maintained value that specifies the number of attempts to dequeue the message. |
> > | `recipient_list`    | This parameter is not supported.                             |
> > | `exception_queue`   | Use the `exception_queue` parameter to specify the name of an exception queue to which a message will be moved if it expires or is dequeued by a transaction that rolls back too many times. |
> > | `enqueue_time`      | `enqueue_time` is the time the record was added to the queue; this value is provided by the system. |
> > | `state`             | This parameter is maintained by `DBMS_AQ`; state can be: `DBMS_AQ.WAITING` – the delay has not been reached. `DBMS_AQ.READY` – the queue entry is ready for processing. `DBMS_AQ.PROCESSED` – the queue entry has been processed. `DBMS_AQ.EXPIRED` – the queue entry has been moved to the exception queue. |
> > | `original_msgid`    | This parameter is accepted for compatibility and ignored.    |
> > | `transaction_group` | This parameter is accepted for compatibility and ignored.    |
> > | `delivery_mode`     | This parameter is not supported; specify a value of `DBMS_AQ.PERSISTENT`. |

*`payload`*

> Use the *`payload`* parameter to retrieve the payload of a message with a dequeue operation. The payload type must match the type specified when creating the queue table.

*`msgid`*

> Use the *`msgid`* parameter to retrieve a unique message identifier.

**Example**

The following anonymous block calls `DBMS_AQ.DEQUEUE`, retrieving a message from the queue and a payload:

```
DECLARE

  dequeue_options    DBMS_AQ.DEQUEUE_OPTIONS_T;
  message_properties DBMS_AQ.MESSAGE_PROPERTIES_T;
  message_handle     raw(16);
  payload            work_order;

BEGIN
  dequeue_options.dequeue_mode := DBMS_AQ.BROWSE;

  DBMS_AQ.DEQUEUE(
    queue_name         => 'work_queue',
    dequeue_options    => dequeue_options,
    message_properties => message_properties,
    payload            => payload,
    msgid              => message_handle
  );

  DBMS_OUTPUT.PUT_LINE(
  'The next work order is [' || payload.subject || '].'
  );
END;
```

The payload is displayed by `DBMS_OUTPUT.PUT_LINE`.

## REGISTER

Use the `REGISTER` procedure to register an email address, procedure or URL that will be notified when an item is enqueued or dequeued. The signature is:

> `REGISTER(`
>  *`reg`_list* `IN SYS.AQ$_REG_INFO_LIST,`
>  *`count`* `IN NUMBER)`

**Parameters**

*`reg_list`*

> *`reg_list`* is a list of type `AQ$REG_INFO_LIST`; that provides information about each subscription that you would like to register. Each entry within the list is of the type `AQ$_REG_INFO`, and may contain:
>
> | Attribute   | Type            | Description                                                  |
> | ----------- | --------------- | ------------------------------------------------------------ |
> | `name`      | VARCHAR2 (128)  | The (optionally schema-qualified) name of the subscription.  |
> | `namespace` | NUMERIC         | The only supported value is `DBMS_AQ.NAMESPACE_AQ` (0)       |
> | `callback`  | VARCHAR2 (4000) | Describes the action that will be performed upon notification. Currently, only calls to PL/SQL procedures are supported. The call should take the form: *`plsql://``schema.procedure`* Where: schema specifies the schema in which the procedure resides. procedure specifies the name of the procedure that will be notified. |
> | `context`   | RAW (16)        | Any user-defined value required by the callback procedure.   |

*`count`*

> *`count`* is the number of entries in *`reg_list`*.

**Example**

The following anonymous block calls `DBMS_AQ.REGISTER`, registering procedures that will be notified when an item is added to or removed from a queue. A set of attributes (of `sys.aq$_reg_info` type) is provided for each subscription identified in the DECLARE section:

```
DECLARE
   subscription1 sys.aq$_reg_info;
   subscription2 sys.aq$_reg_info;
   subscription3 sys.aq$_reg_info;
   subscriptionlist sys.aq$_reg_info_list;
BEGIN
   subscription1 := sys.aq$_reg_info('q', DBMS_AQ.NAMESPACE_AQ, 'plsql://assign_worker?PR=0',HEXTORAW('FFFF'));
   subscription2 := sys.aq$_reg_info('q', DBMS_AQ.NAMESPACE_AQ, 'plsql://add_to_history?PR=1',HEXTORAW('FFFF'));
   subscription3 := sys.aq$_reg_info('q', DBMS_AQ.NAMESPACE_AQ, 'plsql://reserve_parts?PR=2',HEXTORAW('FFFF'));

   subscriptionlist := sys.aq$_reg_info_list(subscription1, subscription2, subscription3);
   dbms_aq.register(subscriptionlist, 3);
   commit;
  END;
   /
```

The `subscriptionlist` is of type `sys.aq$reg_info_list`, and contains the previously described `sys.aq$_reg_info` objects. The list name and an object count are passed to `dbms_aq.register`.

## UNREGISTER

Use the `UNREGISTER` procedure to turn off notifications related to enqueueing and dequeueing. The signature is:

> `UNREGISTER(`
>  *`reg_list`* `IN SYS.AQ$REG_INFO_LIST,`
>  *`count`* `IN NUMBER)`

**Parameters**

*`reg_list`*

> *`reg_list`* is a list of type `AQ$REG_INFO_LIST`; that provides information about each subscription that you would like to register. Each entry within the list is of the type `AQ$REG_INFO`, and may contain:
>
> | Attribute   | Type            | Description                                                  |
> | ----------- | --------------- | ------------------------------------------------------------ |
> | `name`      | VARCHAR2 (128)  | The (optionally schema-qualified) name of the subscription.  |
> | `namespace` | NUMERIC         | The only supported value is `DBMS_AQ.NAMESPACE_AQ` (0)       |
> | `callback`  | VARCHAR2 (4000) | Describes the action that will be performed upon notification. Currently, only calls to PL/SQL procedures are supported. The call should take the form: *`plsql``://``schema.procedure`* Where: schema specifies the schema in which the procedure resides. procedure specifies the name of the procedure that will be notified. |
> | `context`   | RAW (16)        | Any user-defined value required by the procedure.            |

*`count`*

> *`count`* is the number of entries in *`reg_list`*.

**Example**

The following anonymous block calls `DBMS_AQ.UNREGISTER`, disabling the notifications specified in the example for `DBMS_AQ.REGISTER`:

```
DECLARE
   subscription1 sys.aq$_reg_info;
   subscription2 sys.aq$_reg_info;
   subscription3 sys.aq$_reg_info;
   subscriptionlist sys.aq$_reg_info_list;
BEGIN
   subscription1 := sys.aq$_reg_info('q', DBMS_AQ.NAMESPACE_AQ, 'plsql://assign_worker?PR=0',HEXTORAW('FFFF'));
   subscription2 := sys.aq$_reg_info('q', DBMS_AQ.NAMESPACE_AQ, 'plsql://add_to_history?PR=1',HEXTORAW('FFFF'));
   subscription3 := sys.aq$_reg_info('q', DBMS_AQ.NAMESPACE_AQ, 'plsql://reserve_parts?PR=2',HEXTORAW('FFFF'));

   subscriptionlist := sys.aq$_reg_info_list(subscription1, subscription2, subscription3);
   dbms_aq.unregister(subscriptionlist, 3);
   commit;
  END;
   /
```



The `subscriptionlist` is of type `sys.aq$reg_info_list`, and contains the previously described `sys.aq$reg_info` objects. The list name and an object count are passed to `dbms_aq.unregister`.