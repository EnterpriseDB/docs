---
title: "Using OTEL"
navTitle: Using
---

The OTEL extension allows metrics to be sent through the OpenTelemetry (OTEL) protocol.


## OTEL APIs

The following functions are available in OTEL:

- edb_otel_report_metric
- edb_otel.command_from_pg_exporter_definition
- edb_otel.schedule_from_pg_exporter_definition
- edb_otel.pg_exporter_base_definitions (meters) (VIEW ONLY)


## `edb_otel_report_metric`

Use this function to define and group metrics.

```sql
edb_otel_report_metric(
	meter_name TEXT, 
	metric_name TEXT, 
	metric_type INT, 
	value TEXT, 
	labels TEXT
)
```

| Parameter(s)       | Input or output | Description                                                                                                                                                                       |
|--------------------|-----------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `meter_name`       | Input           | A name that you want to group a set of metrics against. |
| `metric_name`      | Input           | The name of the metric. |  
| `metric_type`      | Input           | The type of the metric. Only the DOUBLE GAUGE type is currently supported, which is represented by the value 4. |
| `value`            | Input           | A string representing the metric value. It will be converted to an appropriate type depending on the `metric_type`. |
| `labels`           | Input           | A json string representing additional metadata to be associated with the metric. The maximum size is 1024. If the size is larger than 1024, that metric is silently dropped and a WARNING is emitted to the database log file. If the payload contains an invalid json, that metric is dropped and error information is logged to the log file.| 


#### Example:

  ```sql
  SELECT edb_otel_report_metric('m1', 'foo', 4, '10', '{"dbname": "foo", "schemaname": "bar", "relname": "baz"}');
  ```

## `edb_otel.schedule_from_pg_exporter_definition`

Use this function to define and schedule custom queries.  The query and its metadata, such as metric types and tags, must use the a jsonb structure.  It accepts a jsonb containing the parameters that are usually consumed by pg_exporter, and schedules a pg_cron job that runs the query periodically and sends the results to the OpenTelemetry endpoint.


```sql
edb_otel.schedule_from_pg_exporter_definition(
    meter jsonb, 
    schedule text
)
```

#### Example:

This custom query  adds a count of client backends to the schedule:

  ```sql
  SELECT edb_otel.schedule_from_pg_exporter_definition(
    meter := $${
        "name": "user_activity",
        "query": "SELECT count(*) AS user_count
                  FROM pg_stat_activity
                  WHERE backend_type = 'client backend'",
        "metrics": [{"user_count": {"usage": "GAUGE"}}]
    }$$::jsonb,
	schedule := '* * * * *');
  ```




## ignore below this...
## `edb_otel_report_metric`

Use this function to start a new trace for a provided user and database.  You can use create a trace for any database on which OTEL was installed and configured.  You can define a trace for logging the statements against specific users and databases. You can have multiple traces logging the query statements at the same time. 

```sql
sp_activate(
	comments character varying(100), 
    users oidvector, 
    databases oidvector, 
    max_log_limit int4, 
    log_min_duration int4, 
    time_limit interval = NULL
)
```

| Parameter(s)       | Input or output | Description                                                                                                                                                                                                                                                   |
|--------------------|-----------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `comments`         | Input           | Any text to describe the purpose for the trace. |
| `users`            | Input           | Vector of user OID for whom queries needs to be logged. An empty oidvector will log the queries for all users.|  
| `databases`        | Input           | Vector of datbase OID for which sql needs to be logged. An empty oidvector will log the queries for all databases. |
| `max_log_limit`    | Input           | The total size of trace should not go beyond this limit. Unit is in MB. A value of -1 implies no limit.  OTEL terminates the trace when it reaches approximately the specified value.|
| `log_min_duration` | Input           | Log only the statements that run for at least this number of milliseconds.|
| `time_limit`       | Input           | Run the trace for the this time interval. NULL implies no limit. Interval must be a positive value.| 

