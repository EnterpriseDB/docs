---
title: "Using OTEL"
navTitle: Using
---

The OTEL extension allows metrics to be sent through the OpenTelemetry (OTEL) protocol.


## OTEL APIs

The following functions are available in OTEL:

- edb_otel.report_metric
- edb_otel.command_from_pg_exporter_definition
- edb_otel.schedule_from_pg_exporter_definition

The following views are available in OTEL:

- edb_otel.pg_exporter_base_definitions


## `edb_otel.report_metric`

Use this function to define and group metrics.

```sql
edb_otel.report_metric(
	meter_name TEXT, 
	metric_name TEXT, 
	metric_type INT, 
	value TEXT, 
	labels TEXT
)
```

| Parameter(s)       | Input or output | Description                                                                                                                                                                       |
|--------------------|-----------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `meter_name`       | Input           | A name that you want to group a set of metrics against. |
| `metric_name`      | Input           | The name of the metric. |  
| `metric_type`      | Input           | The type of the metric. Only the DOUBLE GAUGE type is currently supported, which is represented by the value 4. |
| `value`            | Input           | A string representing the metric value. It will be converted to an appropriate type depending on the `metric_type`. |
| `labels`           | Input           | A json string representing additional metadata to be associated with the metric. The maximum size is 1024. If the size is larger than 1024, that metric is silently dropped and a WARNING is emitted to the database log file. If the payload contains an invalid json, that metric is dropped and error information is logged to the log file.| 


#### Example:

  ```sql
  SELECT edb_otel.report_metric('m1', 'foo', 4, '10', '{"dbname": "foo", "schemaname": "bar", "relname": "baz"}');
  ```


## `edb_otel.command_from_pg_exporter_definition`
Use this function to generate a command that can run the query and send the results through `edb_otel`.  It accepts a jsonb value containing the same fields as `pg_exporter` definitions.

```sql
edb_otel.command_from_pg_exporter_definition(
    meter jsonb
)
```

#### Example:

(Needs an example here)

## `edb_otel.schedule_from_pg_exporter_definition`

Use this function to define and schedule custom queries.  The query and its metadata, such as metric types and tags, must use the a jsonb structure.  It accepts a jsonb value containing the parameters that are usually consumed by pg_exporter, and schedules a pg_cron job that runs the query periodically and sends the results to the OpenTelemetry endpoint.


```sql
edb_otel.schedule_from_pg_exporter_definition(
    meter jsonb, 
    schedule text
)
```

#### Example:

This custom query  adds a count of client backends to the schedule:

  ```sql
  SELECT edb_otel.schedule_from_pg_exporter_definition(
    meter := $${
        "name": "user_activity",
        "query": "SELECT count(*) AS user_count
                  FROM pg_stat_activity
                  WHERE backend_type = 'client backend'",
        "metrics": [{"user_count": {"usage": "GAUGE"}}]
    }$$::jsonb,
	schedule := '* * * * *');
  ```


## `edb_otel.pg_exporter_base_definitions`

This view contains the meter (queries and their metrics) definitions that `pg_exporter` brings by default.  They can be refreshed from the [upm-metrics-pg-exporter](https://github.com/EnterpriseDB/upm-metrics-pg-exporter/tree/main/config/collector) or the [pg_exporter collector](https://github.com/Vonng/pg_exporter/tree/main/config/collector) by running `yq` on the directory:

```yq
yq eval-all -o=json '. as $item ireduce ({}; . * $item)' [...]/config/collector/*.yml
```

